{% load post_filters %}

<div class="bg-white rounded-lg shadow-md mb-6 overflow-hidden">
    <!-- Post Header -->
    <div class="flex items-center p-4 border-b border-gray-100">
        <a href="{% url 'profiles:profile_detail' post.author.username %}" class="flex items-center group">
            {% if post.author.profile.profile_pic %}
                <img src="{{ post.author.profile.profile_pic.url }}" alt="{{ post.author.username }}" class="w-10 h-10 rounded-full object-cover border border-gray-200 mr-3">
            {% else %}
                <div class="w-10 h-10 rounded-full bg-blue-100 text-blue-500 flex items-center justify-center font-bold text-lg mr-3">
                    {{ post.author.username.0|upper }}
                </div>
            {% endif %}
            <div>
                <h4 class="font-bold text-gray-800 text-sm group-hover:text-blue-600 transition">{{ post.author.username }}</h4>
                <p class="text-xs text-gray-500">{{ post.created_at|timesince }} ago</p>
            </div>
        </a>
    </div>

    <!-- Post Content -->
    <div class="p-4">
        <p class="text-gray-700 text-base leading-relaxed mb-4 whitespace-pre-line">{{ post.content }}</p>
        
        {% if post.image %}
            <div class="rounded-lg overflow-hidden border border-gray-100">
                <img src="{{ post.image.url }}" class="w-full h-auto object-cover max-h-[600px]" alt="Post image">
            </div>
        {% endif %}
    </div>

    <!-- Stats & Actions -->
    <div class="px-4 pb-2">
        <div class="flex items-center justify-between text-gray-500 text-sm mb-3">
            <span>
                <i class="fas fa-heart text-red-500 mr-1"></i> {{ post.likes.count }} Likes
            </span>
            <span>
                <i class="fas fa-comment text-blue-500 mr-1"></i> {{ post.comments.count }} Comments
            </span>
        </div>
        
        <hr class="border-gray-100 mb-3">

        {% if request.user.is_authenticated %}
            <div class="flex items-center justify-between gap-4">
                <!-- Like Button -->
                <form method="POST" action="{% url 'posts:like_post' post.id %}" class="flex-1">
                    {% csrf_token %}
                    <button type="submit" class="w-full py-2 rounded-md flex items-center justify-center space-x-2 transition duration-200 
                        {% if post|is_liked_by:request.user %}
                            text-red-500 bg-red-50 hover:bg-red-100
                        {% else %}
                            text-gray-600 hover:bg-gray-100
                        {% endif %}">
                        <i class="{% if post|is_liked_by:request.user %}fas{% else %}far{% endif %} fa-heart"></i>
                        <span class="font-medium">{% if post|is_liked_by:request.user %}Liked{% else %}Like{% endif %}</span>
                    </button>
                </form>

                {% if request.user == post.author %}
                   <a href="{% url 'posts:edit_post' post.id %}">Edit</a>
                   <a href="{% url 'posts:delete_post' post.id %}">Delete</a>
                {% endif %}



                <!-- Comment Button -->
                <button onclick="document.getElementById('comment-box-{{ post.id }}').focus()" class="flex-1 py-2 rounded-md flex items-center justify-center space-x-2 text-gray-600 hover:bg-gray-100 transition duration-200">
                    <i class="far fa-comment-alt"></i>
                    <span class="font-medium">Comment</span>
                </button>
            </div>

            <!-- Comment Input -->
            <form method="POST" action="{% url 'posts:comment_post' post.id %}" class="mt-4 flex gap-2 items-start">
                {% csrf_token %}
                <div class="flex-1 relative">
                    <textarea id="comment-box-{{ post.id }}" name="content" rows="1" class="w-full bg-gray-100 rounded-lg pl-4 pr-10 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-100 resize-none transition-all duration-200" placeholder="Write a comment..."></textarea>
                    <button type="submit" class="absolute right-2 top-1/2 transform -translate-y-1/2 text-blue-500 p-1 hover:bg-blue-50 rounded-full transition">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </form>
        {% endif %}
    </div>

    <!-- Comments Section -->
{% if post.comments.exists %}
    <div class="bg-gray-50 border-t border-gray-100 p-4 mt-2">
        <h5 class="text-xs font-bold text-gray-500 uppercase tracking-wide mb-3">Comments</h5>
        <div class="space-y-3">
            {% for comment in post.comments.all %}
                <div class="flex gap-2">
                    <!-- Commenter Avatar -->
                    {% if comment.user.profile.profile_pic %}
                        <img src="{{ comment.user.profile.profile_pic.url }}" class="w-8 h-8 rounded-full flex-shrink-0 object-cover">
                    {% else %}
                        <div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center flex-shrink-0 text-xs text-gray-600 font-bold">
                            {{ comment.user.username.0|upper }}
                        </div>
                    {% endif %}
                    
                    <!-- Comment Content -->
                    <div class="bg-white p-3 rounded-lg rounded-tl-none shadow-sm text-sm flex-1">
                        <a href="{% url 'profiles:profile_detail' comment.user.username %}" class="font-bold text-gray-900 hover:underline block mb-1">
                            {{ comment.user.username }}
                        </a>
                        <p class="text-gray-700">{{ comment.content }}</p>

                        {% if request.user == comment.user %}
                            <div class="mt-2 text-xs text-gray-500 space-x-2">
                                <a href="{% url 'posts:edit_comment'  comment.id %}" class="hover:underline">Edit</a>
                                <a href="{% url 'posts:delete_comment'  comment.id %}" class="hover:underline">Delete</a>
                            </div>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
{% endif %}
</div>

